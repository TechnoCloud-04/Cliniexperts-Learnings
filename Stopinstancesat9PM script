import boto3
import datetime

ec2 = boto3.client('ec2')
sns = boto3.client('sns')

SNS_TOPIC_ARN = "arn:aws:sns:ap-south-1:484907491806:EC2SchedulerNotifications"

def lambda_handler(event, context):
    action = 'stop'

    print(f"Performing '{action}' operation.")

    instances = ec2.describe_instances(
        Filters=[
            {'Name': 'tag:AutoSchedule', 'Values': ['true']},
            {'Name': 'instance-state-name', 'Values': ['running']}
        ]
    )

    instance_ids = []
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            instance_ids.append(instance['InstanceId'])

    if not instance_ids:
        print(f"No instances to {action}.")
        return

    print(f"{action.capitalize()}ping instances: {instance_ids}")
    ec2.stop_instances(InstanceIds=instance_ids)

    message = f"EC2 AutoScheduler: {action.capitalize()}ped instances {instance_ids} at {datetime.datetime.now()}."
    sns.publish(
        TopicArn=SNS_TOPIC_ARN,
        Message=message,
        Subject=f"EC2 Instances {action.capitalize()}ped"
    )
    print("Notification sent via SNS.")
